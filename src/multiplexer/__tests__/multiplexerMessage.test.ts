import { fromHex, toHex } from "@harmoniclabs/uint8array-utils";
import { MultiplexerMessage, unwrapMultiplexerMessages } from "../multiplexerMessage";
import { Socket, connect, createServer } from "net";
import { Multiplexer } from "../Multiplexer";
import { BlockFetchClient, BlockFetchMessage } from "../../protocols";
import { MiniProtocol } from "../../MiniProtocol";
import { resolve } from "path";

const mockPort = 3006;
let socketClient: Socket; 
const mockSocketServer = createServer(( socket ) =>  {
    socketClient = socket;
}); 
mockSocketServer.on("error", () => {});

let mplexer: Multiplexer;
let client: BlockFetchClient;

beforeAll( async () => {
    await new Promise( resolve => {
        mockSocketServer.listen( mockPort, () => {
            mockSocketServer.on("connection", () => {
                resolve( undefined )
            });
            mplexer = new Multiplexer({
                protocolType: "node-to-node",
                connect: () => connect({ port: mockPort })
            });
            (mplexer.socket.unwrap() as Socket).on("error", () => {});
            client = new BlockFetchClient( mplexer );
        });
    });
});

afterAll(() => {
    mplexer.close();
    mockSocketServer.close();
})

describe("multiplexerMessage", () => {

    test("", async () => {

        const socketData: Uint8Array[] = [];
        // const mplexerMsgs: MultiplexerMessage[] = [];
        // const msgs: BlockFetchMessage[] = [];

        // client.on("startBatch", (msg) => msgs.push( msg ) );
        // client.on("batchDone", (msg) => msgs.push( msg ) );
        // client.on("block", (msg) => msgs.push( msg ) );
        // mplexer.on("BlockFetch", ( payload, header ) => {
        //     mplexerMsgs.push({
        //         header,
        //         payload: new Uint8Array( payload )
        //     });
        // });
        mplexer.socket.on("data", data => socketData.push(data) );

        // client.on("startBatch", () => console.log("start"));
        // client.on("block", () => console.log("block"));

        socketClient.write(
            fromHex(
                "81ff9a7180030bde81028204d8185903ed820284828f183c1a00015298582030051ffec49f3601b3caebeb1071139c22f9e2328cd09e6ec6aabd4374fde4e65820d1a8de6caa8fd9b175c59862ecdd5abcd0477b84b82a0e52faecc6b3c85100a4582051995f616f8a025f974b20330a53c0c81e8ea95973d73d15fff7bab57589311d825840d71436fa5baff6f423ccf7e39b85aef6f1b01812940cac3d97d5c4ff58c7230fddef7f47780d9b9584f55b915f586dc25aad8b1ad1fa5793364e198d956bbf5a5850523cc201ff6284f492a3a4c1a16b5eb01f49b1f2cf6a6fc8cae97cd83cdaf230f9bd032e0830611b3c8c36b0875121f25ebddc9ced34aa894ff4ee1b93cdb74cb4c3fbd1c6f1f4cd0f7d0412966a020b8258408c5443d85da1aa4a90d41d4f642a1dedcca66bae564dc6fe752fbf8e6fc2bd0feee404befa96de4228ca50ee33b37257127ed6ec07f3010e41f6d3241fdb5f865850e765e492fbfaeca77f1618c55bdc4cbfa14421112317cf846214c9384aaa7b0313645dbbe25d45366ec3549ffd4aee081a2f84752ab4ceea05f81000cd809cfcbec2c4e408591175149e0cf4535268060358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff758202b9a5add912f3edc5c325d6250b9cc154de8f35e2924f5b1c707a4123808d064000058407fb060b885ffc7b55bb6e095ea6999eaa5608b6b4e92f5cc64bc34ba85000ebe42839432f15d86df07740374f69ce60f72feb16a0d47f5cf2c43158caf37ad0303005901c02a0098675c6096516a92d82b6a975965fba35e339bc7483f3569d258779c30db9a6349cda5c995a8fd9b643f66029e994343e82a254c418ebb59b8966fefc20734d42d5ecf181026f436173ad3036d5be2ba595f5facf920bcb48e8fd8b7b5fbf4f8fad5e652fd99be5d322fe920e702cc4afd218d76bd6800812155d8012c8fd57538a7b9d64f2defee3e32879e36db649a934b00784e6223023bdfffa59f4e54609d63a6f5ad04850c419a3556db8b291b90467fadfc67194a3069ef6ff4c0f7d6677145ceb51be68d6d0c20d0e92f80313c48dabf5ae8e3acd9fc43f450874848221f71d2f895c18790082d17467de32ff047a22cee1799db7e77e651a35c15b32d4f838133cc80d467308587ff5cea12be5b3b8b7d2d0d2eadf066b67cd965100555f96457d0d70988ffc2a7c212afa73338df3ece84ee7de2170aadec1dafc360580432193ab2a25c9c4555e57bc0d88cf50d7036378b4dabde79e5f858539a464e0a547660374da91d7d19acd753e219a8fee41a43bd4190db235dc0b1224bcfb9a760fb2b39063dccce88453043c0297cb6c93bca145a9ebbd6bc3a916ed9439343ac3510c47886d17a9187e833b9149e5ac2854c4d88a7c4b4ee68828080a08204d8185903ed820284828f183d1a000152ac5820f33820e190e37d3c0e8c8db9cf6176fca1f9af7ac6d45097777ed95a99b105f15820942bb3aaab0f6442b906b65ba6ddbf7969caa662d90968926211a3d56532f11d582085504e79a04c8243a5d29b798cbc32a1548f9bace061fad7ca3f4c83ae1809b5825840c9267539cd5b5d3b4e08306a45d141863f62cecf059b038ce08ac0f0c9ebea2aef1fe02ebe580b53440763bc628de7ed571062d73f9831068d1e418bafdbde5f5850a8ea8cf2209408a3c3187d658b32070edd123c93d38c6adb45765d715aa062c303ebda71dbcf6c982b9163cd4f36b58e18bf96be364d83c76f3189e5ebce16f6fe04777444478b0549026771ed7bfb0282584020c06efa53583117419225a5fad6a0955074d15d2b10941727035a12b736fb113a15cd41123c4282120f01622b11e01c63a2e2f344e4fefd46c61fb37c56a3875850d8dbe82544a87034b17e988aa3724999bc4c91676eaf1a16a88f37ab6856ca3d04b850d8c26b544f766435575b86df6c7e6cf6ac9ac7f3d871456ef5c045018e53dde3a4e590d9c1a4969ef412b4b70c0358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff7582054914d6210ca26a038509e3f5b01eeec60719766ec2f839e2c8b2edcb39e4847000058402afe39cf023b5f25961b2e4b9148d533c6677c9c48b81e5d5a2cf52e32040f77683e81f0722baa5dea2ba0a425c5b43e4bb912c34a2f826ef4cc639cb3778a0f03005901c0667edbda2dce739562fcd215a46bc6aae58991feaf8d160ca09acface967a841567045f6ab2339392df2f1c89a76a762efb0fe8ac15ec31fe07a1578313fae071392f7abbdba2e3da2655912c652ab86b7a8cee88c35154d850202b300e8b02966e9a216299622fcb209d0ec5189dd6aa2b11abbc64393be59c7301e633d2df9df83ed37ad9d8ed510ee48292b88974a51e3cb822d8f655f867fd7a6d7b5cf0c58bd1a3e4ef7d9ea8b3f621ce06213c0fb4a8869e4f3ef854c4a9b8721d67bc92e11dca957f9514e87cd1a5e7948810c297d29ced787b0b213b4c259c45ddecce0d25f46028ee9fbda26c47525729420d8bb73511514bc8f8194368686991da9ba35cc7e2d4d02bed059ae157af907a250104e8c7dea2a990ba8ff2f9e3562e97214faa0ab37de93456bb6181fdc71adc9686ed0d377c280a974d634e5334c85115446563e4b0f8afac494d4ab53a7e1ce8e7ded2bdc7e8a92ba9b17eeaabc5c68c67ab091bb0961c81bfe464c400900f317a1015cc7150d2c0a4c0854f15555a8f3bdf04371901a4761caf47837b789df274ffe4d00150e8272b7eb6582d70c2058d490334522c129791172ebecfce136db66cec20a0e332f4df8c9964122e68080a08204d8185903ed820284828f183e1a000152c05820872c093b8802d02468733d41b0835f817b4cbe0e394960aade4b26b057ec6fad58209aae625d4d15bcb3733d420e064f1cd338f386e0af049fcd42b455a69d28ad365820990ed20a21e979e67ae7fd32c86cc6901fe6db52a71bdd3fe6cc45027699ea9f82584023204f0b32a36ec2f24b38aee8a1316b9195219f8f8a9ed22a2aa6f45648284ddde41f9a500c5e1e0ad4d4371c514e441c2193a809968cd9b47872e1436c5bd05850aff18d3c756b30b172dec4b37b5a09b0b66c0a6b26ec8900fee67024aaa5de82c74bc385e7bbd37fbaf9e56d19f3eb6e95710a67af566cbb4d8f768b2c6b3cbc99b241d402fa0889cfdc4b78cbc70406825840f37365d5ef0f7dc497c92c2229f504dd7a39bdc6269924e6e5ea56ef703c8234b1c1edcc13b2cb5eef9032eb8e6bcbe4a4fd2305bdf240eb9842494490ba63045850dd93c97c40daa1dfe05a52ea5d45accd126a6a899f583fe04ee3528c25bf171e97297a78dba6f00e43e3ab94bfcb15ca3e15d7abe12e132e772420ad9851474061483b27861781ba16712975133b1c0e0358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff758208c5c56fa647f8fc1b2bb165f7ac54b16d6cae30625f74f4cab86e048ba442a8400005840777e53f73cc9f1c0c57e8a8c21603111bd952e4476274ca2bf7f950025b36d5d4b469baa55c1a7e428a00891f0241db2fb17c6743493cae21c6538c436104a0603005901c02fbe048cf719fb093256926931a2311c2c0e5987d130602ab8f8f8bcbc800afbcf84474d6a65f48b1ff5a94f3ff8765de24a64738d54f2c8b5a989d7b9a17901016549d5f22ad96c8b5674f210a5f4a38136f402dd5b5efa8b3c833b34893a08b410648c14a182f4931c7e77ecef300673bb0af6e7559e365e2ef51619b669c7187457ac5d48f5eb98b6313e378f8021ecc38f7eaabcec9a857e65138bb9e38f5ff973679bc09963fece5c6f5f684a507939899cddae0d84184411360347acdab4d7a1230f8d19326dd9eebda9f5708ec859105e5ad39ec8a023e25149a435eae93bb0a71b7ac6dcf78216e1be2e92669a32ee480cedda9f790cd4071af8656a6cb357da43c5d8f8c49cfc7a40a16472133ece7bb2b8b540c229e8f81e"
            )
        );
        await new Promise<void>( resolve => setTimeout( resolve, 500 ));

        socketClient.write(
            fromHex(
                "721ebd2a681c9ae662d7bc0323c4de07a60f4869418481710d612ff36057e60fcce5c699491b0db6f9e2e91685f20adbc070433386499a355c80b90c590c6d1c7c5d03899db933d315a8743328099e3c19665fa5eb20dd929abe28d9b99e719f69e8f35c767e235a4cd3dc3a24935797191686979d13e069cd509fefaaf2d7e4dcd0222f3f921997ed111e470c2d896ecb1b4888a1ad551c8e4724ba37e9d95e10c2b68080a081ff9c3d80031bae8204d8185903ed820284828f183f1a000152d4582032d906e15e3492a64ff98c1130848c23bf346c88cee0dbc306d6245cfca0c8765820618b625df30de53895ff29e7a3770dca56c2ff066d4aa05a6971905deecef6db5820707a5e99ceec213eb56768da310566da8f4ff56cbdd90431ebd0ae17f6c8cc8b825840f3947e4053cac21f4dfdb6ec7d0370833c145ea94eecb27441ca77132153d5e040112043fa6ca03cc96f67f7c6ed73a7784c2f40e941fccb87aa2ffb94c6c5d15850199b6f2a87c6bab101c50996be169c1659ea2e3269893bc4724685f12b0fbe873f4b2c2db2196bb111cbc8d42416f058e7fccfe4fd449d774b95df2ca6fabec80973ca76e68c3dac474f8ce9278f2c0a8258406c2dd5633a090d7907e7aed62ee875fd69b926584c6967e41fe456b84a5e0e720117a29fe2cbbcb0782baa95394f17933174c53b1292f82e43101e7d7357b8c058508bfe3a67ab2afe0db74cea6adecbc87a890576cc6f4158da064e7cc0864def2d1abe13eb9fb8375831e41a0c0c5da71c16d0c0d26d108baba134e6b59f5224c0df9e604c68158e3e803d8dcf3f25fc050358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff7582005424ee48b0616cdbd5bc631ed25a628518575912c22c6dfea7e2778aac12bba000058404fa969b5356abab0a3c8a42007a3ab177d17aebdf4bedd93a541f545544a01dbb6e2696ef58ee8cf96c214717a4ebd35f2fa992d5815db01382f1bd516a38c0503005901c0978e1f3d6beee24a40edb21bc642dd16aa8955bd69fdce74b14fbbf03f9267dca49542a4149f9a5c4f4c506e0b6eef20a676d640d011289e79edd8e9d6e9fd0cdb583a4dca644ccb0b61eb1e9ecb5f137762436478a69380b192024caf935311673cb5ad6db37f46f59fba1b2f4118def517762e0fa0b1dbc37ff3e607ab5a2b457357d4ca71f38ed7e84fbd03007c61f32f2f070c0dd667ca678c727d83fdadbf4b7799b5f31b1285ca83758a388bcfcabeff17be1429a5df112cb5ba90f6799ba5091ce00397cd56ed509a875c177cc8b8b52b5e1bdba6aa414d966c5c6fd20b05a932284ca9902735bf350c0eda9af447beaad02703960b427a7368bb73b38fe90d56d3364c761b9a3ae0acb285054cf7ce0573d05464e1ea1b298ed8e876442244df9e3f19c4b36f8b4e09e0c63aeb48ac8f1c16af7897aa2a7846983f9d58ad4f84a5fa579f48028b66b9bc0617a2e9c67625cf98fc0b2df820393c63cf8b35c98874f8592752a1c8b34b09ed2d08d3ffc97c567152af96a1044485d66316c4ba224361e8ce16423fb537346f6cb4a9e1c2b3cf496dffe8e5a59cdd274d40d8f7d1a2ba6fc0aa3ce682e635272b9e57bac008586e14b67926c5bb2412478080a08204d8185903ed820284828f18401a000152e85820fdf74badb9d04ca849a9f78e644f55bbc078a697ffd95df251ec09b10aa492675820d4dd69a41071bc2dc8e64a97f4bd6379524ce0c2b665728043a067e34d3e218a5820859cd08dd516e4db46ac84428d05b9fd7a20917a897fe3d8a49018dd2ce605f0825840b5d183e6b3abfac5206c37fc940bef01cdbbdd92d99da7c755847232efcfd5adc271037b1ffdbcc2eb75200e4c02518313cc75bbf303482489bec25bc5bc9b005850c57942ac603192e6184b9992681c50cd1ab8479da06bffe7e5fa59a473377fdbbd9df0da627ad53d978c044804479b22d942dd37a904714452c7f32f9b221134e0c84b695eaac25c2689176aafcac10a82584070fa2ffa0ce8020ec8482fc2f8eb929e161fbdfba349344480ac62ea6a168527ce8cda7b160d785790831091b1cde7effc037b4a32751e9ea88f9ca6dae20f4f5850a600892b81a87bccd80060c8134b3ccf9a57423c79fd53f02b9cfc9bebb7d936a9190f79505d23d7aefbc829d41fd264b0cf12f64c6be10339355113dec33c8837ef6a71245a64d92dd9a70daf49a40f0358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff75820b2613a87a56751da1444807b534614cf4186d43c8b6965ee69853d36f8cd2c62000058408266a196f64035187a2d2ae90b1640cf55def70a084a9938ffad40307c00f01e264f29f3493a600f74427d6db98822f5419148ba25d33d968bbcf6a53823810403005901c0c6f07eabfe138d1e10dd80a2b53c60da71fbdf79856e4f4553511deae57aae369fa8944b6365af598fea46384035852fc08b651553bee6bd413b07aacb7dfa05267911edd87dc8597bf7fd3efa0d47050910737c572d37bd2e304dfe7a76c7cecaadaa860e07c11c5dcff0707aa7b36d572bad5705b608b55852fc2731866d442db83d94443c268eaa3af09368301a4a813ab16bf94bed8d917c7be0cde4a02fa56d194551bbbe0a57533956b9e43a082310108eac718fc26b0f8923eff6b8bf4624967f5577df3ae3de68fcaa8d3a2ab2ca63f9b9b5fde9f83d52128010496a60a5304b8762e72462f9c9c1f66e37d2fdfd29e68c3c3516a929ffe7dad892dffdb81a480717626bcca40cde13ad74548847a9d02743049995df233bff94a59b5da86288a6581992706398f2494b37e23d18a6befa8ed3e3e330c75505b8c062be8a47bdf4afa14fa0a46727c9869b783fc00744871a9524f79a650d2a3513cbffe79f6718a6eca2ec6f1b3de82f34e163b4a5ac2ff5ea99c04470d626c82b425213184a0c3f939ad3ec3317b2b647ba3b1276622a51d729290fb3e79fb580a3f7c8d00456ccd35192666019c71ef8e90ff243cdb4a21a6c3742e8dc9380b6c68080a08204d8185903ed820284828f18411a000152fc58205d03667ba3efa2d706f60fb980c87b02e81fd277fe76fa011c09b68a4d5e985d58208b0960d234bda67d52432c5d1a26aca2bfb5b9a09f966d9592a7bf0c728a1ecd5820a61596a4b7d69dffaee86116b15c4e1cd0078d8d7bb17103ee3807d269e90539825840000c77b966b27d59df118036d16a4d90802cb283ed75780b2cad03323ffcc3e47e9a08ab7c9435a47fc4aaf1ab34977d3bf222dec2349cbf54b328636644b34358502cf819cc104e39e0c53152b55fb07e62fde8cb3b1cd40f2e141f3cf0cee82d9b0334926beee88868cb400c24171b610592d8af31d5a62a82a9df22a3ad8ce6e8c832a21961803222f751ca15bda3a101825840b2f563ce662e3b127b86be1620a43097a9b5dd6f9cee8265a926c50820cce9db94a67070055d32e295e0f433c1e4e17a286eb29a7b8840f48ca8c6439a3fd92158501d7345bd7097c23f715a84b7bd0dea2e40e939be5fecdd08007fff77bead99c7b55997e35bc77ace25521a3e4ed45370c636433d3ef72fd31dd7e784dab84def11324a34ba85097343a3f84e31857a0c0358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff75820644d7d71a017b3ee77d7c2b7e99eaac6a82a6be05b328ae8b4134f3914685a56000058402452fb84bec88cfcf2b9370f2cd0d599b3e897349b1fe3721a4ccfea1b0f79208cb735f4660a0318b09f830f08c37af177283c572a4c925986d8fcefde21950603005901c060ab53bcff7157ead9d609fa51eccfcbbec6ad913d21f88bb9117046bdda1b47bdf430cce357dc0b5d20cbeb0c7d4ff9d44dd0c6a49ba0babdda75964f1670089cb87caa33b93a49aecaf619783347e52bb72803137c51f963e9f091792405a45eb303f1fb919f0ad88b541413b029325d76db4aa4920aa2b0f492f6899335bb8d35491a6b28ec3490bbab65f4acaebb333fdfc9b03b350f0a4a5ca712c8507977bd0ab135deaa66d313351e09db44bc7e72a8a7e2f0b18c3fdd2e9a5076bbf717d6b725ecf41db8cedc43194754290abe1d6acc36e81bf9a267dd9a7a9ea2de3c378dadd52ecb2235e7785081064580fcbfb8c0f71eb7d7a8f2f95161c869291a5be3e19178793e07c0618a01fa76a4ed8903fdefe76bfe0b915fe6cfb28ff3960d87d734c91461c4665910baf69b35543baed19d0956c33459e92685f1bcf2515ce2b753bc5112e3d0c0ce912939946200bf8380b78c03359d6b5bae9cbedf06199516b21bacffbd1e01735157306cc8995bc9722886341ef73043da2d426467c4aaf383dd079b8a567e8e2dddc4b435077432f3bfe8f8ec4ac03cfb93c7816c9ccbd15d142c8bd334d3cfd713f8caaa9eef2aeb9618354f382edba6386f2c8080a08204d8185903ed820284828f18421a000153105820fc223f66dc6b20f8954e527e6553ffec877a3c8985e2e7939ae028d3bb2a58cc58208ef320c2df6654a6188c45e9c639c0a686bf5a865295587d399dfeb05fe74ab658202fcee99271fc3d5213355a220c7c0516c460cbc18abb494c6e28acfa0fea31b98258401c17cf4231f2e9c6ed385cd9855756770f435d2bda975ce2f832398f43c5f3016c6d146c8d1168da1cb15a87d91e97e110c38770e404da3a6408af0023b84c5958506363bc9515d39c8f3cdc0495199329c06c40b7898366165ac89ae49022857ea03eb3afd297f015dfb20078033e56819453e54c224c4abf7a41254c0e0afad614cd7d71fa8987564f6fc7817074dff704825840f1eca1763a71385c7fa22fb330cb286f168918ca135d994b8ed06f77b2c71230e786c18873c73289bb65eca904d3dc460da46bdb1a9f7eb969d27060988fbfa3585010abb69141f7a2bed1a44682c155b689e5b2a1e5dcc2aaf4d3ee24ab688585aa51158f52c449c7d436dc06c05221c869c3614b579c9dd0be91e09c20c49a51d69796967589aac52338b8667da5bf1d010358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff758209abb516c804466650fb29d18f374c9ce10cfd94fdc1a2c9bb95196a2e863019c000058408103d7e78df8a47d6cd736eaf49028f02d2480f968d451396f696b5c451f1529fa261eced4ff5ca31069ea5cad9de84e42294969f55b0ac60cc725b9e843160403005901c088e87fe037b629de6ee39ceb74963bd537347810c8b7e87643737ceae12b5f05039ccc8fed53b00563ecdcb74d5b53f54fc364625bd6ec9565842d74d0613609d0271e6d3762f4ed9fdb750a47f86c8b1275c74f5fdd86e662bdca328c3a586caaf8e9bddf76870149cb61ffb02c54015b12cd80a3f88ca6390a0d4be80d00f2eeca6c624b8b8d9878b9f3be5f3704be75996da11dbbd929e99e912129a3d55ecc48e2ef45a113e59ca3634e69897516503810e74404fbfbf9868a6c32f835e2e9d3e7621e0502580d0632273f4db22a97312d7ef1eedad31aed6a0f5c3333a9c73bc83b876e3c3162c5dd0ce56811142c8c70e2b7a8e30afd164eb6e9b217e7f1fbe2dd5514c3551bd88fba9b4cc96bac701f7ccc9d97394bea6568a254025b849354974150479266721cb2ebb337fe810afd51b7b531a99a6f9c9f058b7f741893b57c632b4b8ed89ce96fa837a58f6ddd694453fafffa7c190a096f8393376638e64663acedd495985186767b16f14b5803d7e2b6d51b607b575e650bbfc615e185c917bbbe2e6ce0d93c175e26f9f568c134eb0d8cde6e7a095513c04d992ec6d5b44085a1b791fdbe01422a012620959b1c0f4407dc8eee5d0efe5e68c88080a08204d8185903ed820284828f18431a000153245820b69c4254d5ce837c9b922165c7055d5ec4f8fdc911c61a0750a616eaffa8e89a5820d1a8de6caa8fd9b175c59862ecdd5abcd0477b84b82a0e52faecc6b3c85100a4582051995f616f8a025f974b20330a53c0c81e8ea95973d73d15fff7bab57589311d8258405bf86483cde4a8ca361576ebe94a3d513e20864ce762c27a20d58b301fcf4b74f22f1a23033c93494c6dff5c2bc2b9c3954c3ac70cf7bcbbc8170ea8decb7b4258500571fed5d3db8f52a8c704de9a83288b913b92ae7afafbe4b13ec5dbc973327db2ec5df2fdd4689d9c5faa8f02a3aaca3475067cfeeff4c3edeaf0fded6f5489f76a7957981284c73dc6cbf543228a0082584063e58077f38292a30a2cf0f105e983d77f4a7c9079ccce6d56855f03d2eff05ef5990a54a5c7f242562a9bec1d4726ac32907fc44ac1b39e614505809f07bc96585038bd07f1a48e677c792cb4111931b0156aed34fbe2494523aa302fc683f893607c1b5235c215a790383bc026a84ecf333e51487de081f0d5c021deec29b91e67fcad4826c0bd58e52b8b4a2fd24a2e0e0358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff758202b9a5add912f3edc5c325d6250b9cc154de8f35e2924f5b1c707a4123808d064000058407fb060b885ffc7b55bb6e095ea6999eaa5608b6b4e92f5cc64bc34ba85000ebe42839432f15d86df07740374f69ce60f72feb16a0d47f5cf2c43158caf37ad0303005901c0a823a54c6255e9f64572dba10696c892a8f7bb5132889c1822662f314d0b9ce1ee23a4c57e9bf5dab3526cfa29972914d5a64f4bb075df96296ad7a64af9fc0c34d42d5ecf181026f436173ad3036d5be2ba595f5facf920bcb48e8fd8b7b5fbf4f8fad5e652fd99be5d322fe920e702cc4afd218d76bd6800812155d8012c8fd57538a7b9d64f2defee3e32879e36db649a934b00784e6223023bdfffa59f4e54609d63a6f5ad04850c419a3556db8b291b90467fadfc67194a3069ef6ff4c0f7d6677145ceb51be68d6d0c20d0e92f80313c48dabf5ae8e3acd9fc43f450874848221f71d2f895c18790082d17467de32ff047a22cee1799db7e77e651a35c15b32d4f838133cc80d467308587ff5cea12be5b3b8b7d2d0d2eadf066b67cd965100555f96457d0d70988ffc2a7c212afa73338df3ece84ee7de2170aadec1dafc360580432193ab2a25c9c4555e57bc0d88cf50d7036378b4dabde79e5f858539a464e0a547660374da91d7d19acd753e219a8fee41a43bd4190db235dc0b1224bcfb9a760fb2b39063dccce88453043c0297cb6c93bca145a9ebbd6bc3a916ed9439343ac3510c47886d17a9187e833b9149e5ac2854c4d88a7c4b4ee68828080a08204d8185903ed820284828f18441a00015338582059f9ca54beac59b95324e7475ebe0e74772f8da97ff41899182b95409816c7005820942bb3aaab0f6442b906b65ba6ddbf7969caa662d90968926211a3d56532f11d582085504e79a04c8243a5d29b798cbc32a1548f9bace061fad7ca3f4c83ae1809b5825840bdc6cc8731d1e0164852726ac1f8d890e82546bc2a5563f639bc6dea4b6e8277a013c86cc3bd244502dc48af80d75f2875dcfe182e407ff3f7fc8de331c823525850df4f2754af7a89ff1786feb16c06ee0be845da8f1cb16f4513acbeefbd8e9c8a8e3b92b9907b7268d6d9d27db76987c9a00d74133a00c53a96cdc5d28a4b7bdbfdcddedc7d4d67405d916524ab1aa708825840418f5dc0cd2880e03a092585af7f61854a90ae854a63b816e9a9538bbd96d22df7b16e29ae57a9c1c81993ccc268265ed35447d2dd87f8d1e341a98817f353fc58508d7a36f18189a3803caa4825eaf480aeafd9b53d877353e3f109cce52e96993b7ade6a04af61f6bdf70f1b9afa82a56e5048954c87a713c743fd57185c76fe60c9986b930f1dc407a8ba17b67095480d0358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff7582054914d6210ca26a038509e3f5b01eeec60719766ec2f839e2c8b2edcb39e4847000058402afe39cf023b5f25961b2e4b9148d533c6677c9c48b81e5d5a2cf52e32040f77683e81f0722baa5dea2ba0a425c5b43e4bb912c34a2f826ef4cc639cb3778a0f03005901c060f9e704540a8fd60e4ed2ec3b3c2a84201273b75d2a63e83268d8dc22b5c1f1b33871cbaa250db7caec639d3f32661cc52f8769f026cd4cb7024eb7de724b051392f7abbdba2e3da2655912c652ab86b7a8cee88c35154d850202b300e8b02966e9a216299622fcb209d0ec5189dd6aa2b11abbc64393be59c7301e633d2df9df83ed37ad9d8ed510ee48292b88974a51e3cb822d8f655f867fd7a6d7b5cf0c58bd1a3e4ef7d9ea8b3f621ce06213c0fb4a8869e4f3ef854c4a9b8721d67bc92e11dca957f9514e87cd1a5e7948810c297d29ced787b0b213b4c259c45ddecce0d25f46028ee9fbda26c47525729420d8bb73511514bc8f8194368686991da9ba35cc7e2d4d02bed059ae157af907a250104e8c7dea2a990ba8ff2f9e3562e97214faa0ab37de93456bb6181fdc71adc9686ed0d377c280a974d634e5334c85115446563e4b0f8afac494d4ab53a7e1ce8e7ded2bdc7e8a92ba9b17eeaabc5c68c67ab091bb0961c81bfe464c400900f317a1015cc7150d2c0a4c0854f15555a8f3bdf04371901a4761caf47837b789df274ffe4d00150e8272b7eb6582d70c2058d490334522c129791172ebecfce136db66cec20a0e332f4df8c9964122e68080a08204d8185903ed820284828f18451a0001534c58207dab2681a5e4e42831f05e7d171df361ec0ee4d113b5d13a66af1ca6dedbdcc658209aae625d4d15bcb3733d420e064f1cd338f386e0af049fcd42b455a69d28ad365820990ed20a21e979e67ae7fd32c86cc6901fe6db52a71bdd3fe6cc45027699ea9f8258403e1c5fa4b6c69e1e17caf713e58e32ca83618141a1f0f3c2c38ee61ca49bb3102efcad1d93c8e4fcdc527cbd60add9b8c4338c3e7a085c2a54f8a354f8f114da5850762df275516d2ca07d7422ff628efaa17ea7fdc5c2cd45927950e08498d934bb5f5edeb6f94fb08d93fba46f002ea39371301c937156409b90a0eea0dd72372dd20b43605582d312efadaf29f2843a04825840b8d8ab778e4044bddaf88011b9d15e4a8e5a2e1ebfaf23d9aaf425facffd08e22a3c1c261aaeb8942938e57c305c4e338449e55d9ca119441f90b202d3994a7c58506f03299408bcaf8173290babde73d0420e32d74e113a3a6eba07a59b35d8089ab73d0ddc7e6c8e4f86e69d1519aa72237debf76f8d96e00cc8db153d58ce6407377cb8f45b961a5aa18fd04e918c42040358201033376be025cb705fd8dd02eda11cc73975a062b5d14ffd74d6ff69e69a2ff758208c5c56fa647f8fc1b2bb165f7ac54b16d6cae30625f74f4cab86e048ba442a8400005840777e53f73cc9f1c0c57e8a8c21603111bd952e4476274ca2bf7f950025b36d5d4b469baa55c1a7e428a00891f0241db2fb17c6743493cae21c6538c436104a0603005901c08292f769aa95f830c2c93120d85c1133e410df44e7e78f8abe2e6139db9b51c795d9ce875dd25d22cd67eda64fc90b790541db85e4f1afc8c8436cd18e5a5705016549d5f22ad96c8b5674f210a5f4a38136f402dd5b5efa8b3c833b34893a08b410648c14a182f4931c7e77ecef300673bb0af6e7559e365e2ef51619b669c7187457ac5d48f5eb98b6313e378f8021ecc38f7eaabcec9a857e65138bb9e38f5ff973679bc09963fece5c6f5f684a507939899cddae0d84184411360347acdab4d7a1230f8d19326dd9eebda9f5708ec859105e5ad39ec8a023e25149a435eae93bb0a71b7ac6dcf78216e1be2e92669a32ee480cedda9f790cd4071af8656a6cb357da43c5d8f8c49cfc7a40a16472133ece7bb2b8b540c229e8f81e721ebd2a681c9ae662d7bc0323c4de07a60f4869418481710d612ff36057e60fcce5c699491b0db6f9e2e91685f20adbc070433386499a355c80b90c590c6d1c7c5d03899db933d315a8743328099e3c19665fa5eb20dd929abe28d9b99e719f69e8f35c767e235a4cd3dc3a24935797191686979d13e069cd509fefaaf2d7e4dcd0222f3f921997ed111e470c2d896ecb1b4888a1ad551c8e4724ba37e9d95e10c2b68080a08105"
            )
        );
        await new Promise( r => setTimeout( r, 500 ));
        
        // console.log( msgs.length, msgs );
        // console.log( mplexerMsgs.length, mplexerMsgs );
        // console.log( socketData.length, socketData.map( toHex ).join("\n\n") );
        // console.log();
        // console.log( toHex( socketData[0] ) + toHex( socketData[1].slice( 0, 166 ) ) );
        // console.log( toHex( socketData[1].slice( 166 ) ) );
// 
        console.log( unwrapMultiplexerMessages( socketData[1].slice( 166 ) ) );
        // console.log( toHex( socketData[1].slice( 166, 166 + 8 ) ) );
        // await new Promise<void>( resolve => {
// 
        //     client.on("batchDone", () => resolve());
        // });
    })
});