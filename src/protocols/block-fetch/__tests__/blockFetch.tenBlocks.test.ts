import { connect, createServer } from "net";
import { BlockFetchBatchDone, BlockFetchBlock, BlockFetchClient, BlockFetchMessage, BlockFetchStartBatch, MiniProtocol, Multiplexer } from "../../../";
import { fromHex } from "@harmoniclabs/uint8array-utils";

const mockPort = 3005;
const mockSocketServer = createServer(); 
mockSocketServer.on("error", () => {});
mockSocketServer.listen( mockPort );

const mplexer = new Multiplexer({
    protocolType: "node-to-node",
    connect: () => connect({ port: mockPort })
});
mplexer.socket.unwrap().on("error", () => {})

const client = new BlockFetchClient( mplexer );

afterAll(() => {
    mplexer.close();
    mockSocketServer.close();
})

describe("10 blocks", () => {
    
    test("10 blocks", () => {

        const msgs: BlockFetchMessage[] = [];

        client.on("startBatch", msg => msgs.push( msg ) );
        client.on("batchDone", msg => msgs.push( msg ) );
        client.on("block", msg => msgs.push( msg ) );

        mplexer.dispatchEvent(
            "BlockFetch",
            // payload
            fromHex("81028204d818585382008385015820d4b8de7a11d929a323373cbab6c1a9bdc931beffff11db111cf9d57356ee19375820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b8200810081a09fff81a08204d818590271820183850158209ad7ff320c9cf74e0f5ee78d22a85ce42bb0a487d0506bf60cfb5a91ea4497d284830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e40988482000258403fb2637923c78dec4d5b932c09ac92ad445aa95da00a05edb447b40a07c59d5645187692f40e31114ad0f375532cf8e4f875740e2d7d0e343e0e14b533a31fec8101820282840058403fb2637923c78dec4d5b932c09ac92ad445aa95da00a05edb447b40a07c59d5645187692f40e31114ad0f375532cf8e4f875740e2d7d0e343e0e14b533a31fec58408ef320c2df6654a6188c45e9c639c0a686bf5a865295587d399dfeb05fe74ab67961a696b268c8bcec9372bc73aa9b1365ec007b3dfa0539eac00d154a31518c58409ef9f0e5ca23cd9365ec7a23f1b2d159da0d58e0242cb817c3bc946ba1c9e3629f1976f09a88370247bbc458c810d21a889e3ff6dd189ceea784bc9ab6dc9b0a5840bca69660e51257e41223eb89c4a187138f1b0716dea94dcfae74d5cec3ae9400ff120cf07c0f83d48564d5c70115cb3c71576096062572e14b23ef058021d3068483000000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d818590841820183850158201d031daf47281f69cd95ab929c269fd26b1434a56a5bbbd65b7afe85ef96b23384830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b5820572e46c1a0165e31e5781ed59917ac065cf60ec01e2fd88872c55e50860c9d518482001908735840505b237a1cb140020cc442f6e51c6a0f48ad3344427735a9ad5b755bece8a4ce5bed4f6bbbd00caffcdff6502359a16534ea5182badbcfbaf9b516edf305264a810282028284005840505b237a1cb140020cc442f6e51c6a0f48ad3344427735a9ad5b755bece8a4ce5bed4f6bbbd00caffcdff6502359a16534ea5182badbcfbaf9b516edf305264a58408b0960d234bda67d52432c5d1a26aca2bfb5b9a09f966d9592a7bf0c728a1ecd840eac5c3fe8a7edda024a7403b6d37705990828b3548332a3f850221c2098bf5840633fc347138ee155d038b9d1040ee1e45cea5b1e8627046c95f7fe4ba949b0569437962568eadef9d49e22becbf30192425c008d10e03004612633dbc307340b5840f5faa76fe8c1e2dac09bccd6696fc76dd4c0fc2780951eac58cade1693a5c59d6b1bc7f98245d173fbd0c0c9efc83349643834ea51af0a82f53b88cc44b48d0b8483000000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff828187830100008e8080808080808080808080808080826a63617264616e6f2d736c01a1656c696e757884582003170a2e7597b7b7e3d84c05391d139a62b157e78786d8c082f29dcf4c11131458200fd923ca5e7218c4ba3c3801c26a617ecdbfdaebb9c76ce2eca166e7855efbb8582003170a2e7597b7b7e3d84c05391d139a62b157e78786d8c082f29dcf4c111314582003170a2e7597b7b7e3d84c05391d139a62b157e78786d8c082f29dcf4c111314a058408ef320c2df6654a6188c45e9c639c0a686bf5a865295587d399dfeb05fe74ab67961a696b268c8bcec9372bc73aa9b1365ec007b3dfa0539eac00d154a31518c58408ac677b7ff7875d6d7c174969d19eaacb5fefe11c6a44bc678b4ae06885f3906a6f94d3d18a26698f13658570be23b95e553d59bcd0939db505b4822dbf3ff049f8458408ef320c2df6654a6188c45e9c639c0a686bf5a865295587d399dfeb05fe74ab67961a696b268c8bcec9372bc73aa9b1365ec007b3dfa0539eac00d154a31518c5820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f5584074902a37be48431a6470ea8dfebce7070d2de278854ca391d48a5f48e859ba302256221597224e4fb12d155626fa415b6696eefe80e3e43609a76a51c5cfba008458408b0960d234bda67d52432c5d1a26aca2bfb5b9a09f966d9592a7bf0c728a1ecd840eac5c3fe8a7edda024a7403b6d37705990828b3548332a3f850221c2098bf5820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f5584092347c2c8332ed692b0efd5ad0ce53063f4a8d75de4e36b4170c6501069a2b85f07172e1bec628dc4ca6ad44a98e971db9f5b2660c2a952c199bde9fb61e400b845840d4dd69a41071bc2dc8e64a97f4bd6379524ce0c2b665728043a067e34d3e218af89a1e334d87220ac4c94f2bd8f0828804111c4f71985ba665698cbb5db639925820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f558402b18ff7dc379889c4042ab9bc66b9f0b8138802e2faa699bad1c4887ffe76151de78c52edf548d14a5191b83bd2fbc421a3736e82711650b11fceba5868d510c845840618b625df30de53895ff29e7a3770dca56c2ff066d4aa05a6971905deecef6dbb7dd10ea1f9175e5293eadec97bf16b167af379a7b3ed4af032cd07b99ecc1ea5820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f5584008fe8e6d92d460bb65a2a49b26aa9113c708fb9ec56e6f482060e774254ea1ec0fc8f8ad77be7f1baf35ccfb9de508f4a6c63f0af59d7ae2bb745f2f40dd0e0e8458409aae625d4d15bcb3733d420e064f1cd338f386e0af049fcd42b455a69d28ad366483d177ba2b801b4136e0d6662e5e9e0a24f2c80a0e78d4c235b4c08f201f4c5820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f55840000d9297b45ba4d0bc33d3aa4e0a1c87d09d5773fc15f57e0741b791c5ab1c357184089b1364873c4925d3f99eb48af9c9d0592d8c91bea1187a981e74cebd0c845840d1a8de6caa8fd9b175c59862ecdd5abcd0477b84b82a0e52faecc6b3c85100a475216ffb64ea74537021405bb328b0f706e4aad7157795e316781cca120dac965820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f558403ea4f111ce4dd159ee116c3c5aa03384cae87a0afd2ad9dbb742f6fafd03c03b2f469cf1d4718948b296dba621a564255859ab1d7854b4fb77d89fcb1e508a01845840942bb3aaab0f6442b906b65ba6ddbf7969caa662d90968926211a3d56532f11d8e8cb4adc3f5034fbc6257fa5b1086689dc7d024df7226aa501fc28eba2d1f635820561a907d9d313c7a3b769db775eb9f2a00af344952d8ae906a5f4e363d6ed3e2f55840b99c70fc219bf98a1822ca1a322458818baf3a2a6ff9e7dc18b3adf4f80528e29dd0fc1df6c141dd02d2dc19489edb7635755da79ddcff11742ed245c9d33f0cff81a08204d818590273820183850158209972ffaee13b4afcf1a133434161ce25e8ecaf34b7a76e06b0c642125cf911a984830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e40988482001910e55840bf29db977abf045bf07a180cce9a7736858eb8de51c0351809b368a74451d239445e89a03ceae55c2c0c4ebc2b23c0dc7f3ab9ab57caff584e7eff48c0330f00810382028284005840bf29db977abf045bf07a180cce9a7736858eb8de51c0351809b368a74451d239445e89a03ceae55c2c0c4ebc2b23c0dc7f3ab9ab57caff584e7eff48c0330f005840d4dd69a41071bc2dc8e64a97f4bd6379524ce0c2b665728043a067e34d3e218af89a1e334d87220ac4c94f2bd8f0828804111c4f71985ba665698cbb5db63992584082b10bbea2dd80441315230354e3e4af0ac87d02c9e6424fc9432be21a6183c81555d3a1b373566aef7a8065a126d57c42629be780becc61bc1b8f3ce5b5170d584069720ed5efd64d7009c7bc657b2a452af3f9fb6081a4242a79907b1439d69ad2af09bbc26f8b751e305baad4f770fec1c4a73f2833edfec2b7ad714ac06e19038483000000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d81859027382018385015820f3d7cd6f93cb4c59b61b28ac974f4a4dccfc44a4c83c1998aad17bb6b7b0344684830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e4098848200191950584063e55a8f421a31eab4fa85a342be61884978124f9c5ac2aaee6b9f4cee30b9ed91e80e80325a840c857bbd8b1ddcd656a261b90c6730480c3612fd4ccf6e8b2081048202828400584063e55a8f421a31eab4fa85a342be61884978124f9c5ac2aaee6b9f4cee30b9ed91e80e80325a840c857bbd8b1ddcd656a261b90c6730480c3612fd4ccf6e8b205840618b625df30de53895ff29e7a3770dca56c2ff066d4aa05a6971905deecef6dbb7dd10ea1f9175e5293eadec97bf16b167af379a7b3ed4af032cd07b99ecc1ea5840ca38e688e759183b57d08ca6568248b91c8ddd81e56d0d31c3f3a26eca35754387c5f301ef017dafae453a93757d39a0e2d326ebe59cf31d5c1b22fc8616ac005840c714da33d72c7a69029402283ae5e76be27b3e87072ac207256543749e0616fc465699ede3b9d78010605469a533c886be8c8b73d966fb9f1a4ceea950fa7e0d8483010000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d81859027382018385015820ab0a64eaf8bc9e96e4df7161d3ace4d32e88cab2315f952665807509e49892eb84830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e40988482001921c158405eba3a05b57a84c877453667b2de00061b50dafafcdd83d7a0b7d0f0959eba7bef72eb9d18142f2deab055f197ac15a830e38aae8155e3cca07d212adb1851108105820282840058405eba3a05b57a84c877453667b2de00061b50dafafcdd83d7a0b7d0f0959eba7bef72eb9d18142f2deab055f197ac15a830e38aae8155e3cca07d212adb18511058409aae625d4d15bcb3733d420e064f1cd338f386e0af049fcd42b455a69d28ad366483d177ba2b801b4136e0d6662e5e9e0a24f2c80a0e78d4c235b4c08f201f4c5840939dcfe5555ee661b9db5d817a70d5c3fa9d1d97c2ae5849696d915606b530f7e9edda5d02a01e61524a766f9c356084616ba058a3de70ea51bf29cd187a5f07584039f2b9f7d79d39f7f3b51af5ced7edd44f5590f536775aa33d92533517db59158621127a358498a823379b7ef4d1d42e9749c5491e775b38b10e06cd9fef480c8483010000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d81859027382018385015820f5441700216e5516c6dc19e7eb616f0bf1d04dd1368add35e3a7fd114e30b88084830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e4098848200192a325840a4020008c1ba5826b89b3d2d56879e90b5d8b9691dc64feb803b99ff1eee821dc2bc4ba1a467f62d14515a295a19dada1f5b026e7b8c0a6007ac14db3c3166c4810682028284005840a4020008c1ba5826b89b3d2d56879e90b5d8b9691dc64feb803b99ff1eee821dc2bc4ba1a467f62d14515a295a19dada1f5b026e7b8c0a6007ac14db3c3166c45840d1a8de6caa8fd9b175c59862ecdd5abcd0477b84b82a0e52faecc6b3c85100a475216ffb64ea74537021405bb328b0f706e4aad7157795e316781cca120dac965840eb5c4d76c7bfca2ab790a76f7dc4c6d9f7d0956d4af3b8c649804ef98beeb138d8916982c9142747b7a07e69f52b2c3776d64a7d74494e0f72eefaebf6bf5d07584035099ffab74dd0e8d6f56541b23e5012b9f1495912efb5543fa1a5d2a4ce2f5eb7cd1ee0fdc11e72ab28eca8ade995dfaca68bd95c400f4aca73b55b845c1f018483010000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d818590273820183850158208e2e24608ab3a9ec0cbf6b2e2b88574aae84955fcd5f89c604e52e33cbee988384830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e40988482001932a158407aa000b6ed57efd3310926bf8bf4520292c6b2784362a2c92eef777f7c12cd1e7f33b71a9594bc0c716b02d260cd86e483d9f0285d47410f1b3bfd4b389f4ee38107820282840058407aa000b6ed57efd3310926bf8bf4520292c6b2784362a2c92eef777f7c12cd1e7f33b71a9594bc0c716b02d260cd86e483d9f0285d47410f1b3bfd4b389f4ee35840942bb3aaab0f6442b906b65ba6ddbf7969caa662d90968926211a3d56532f11d8e8cb4adc3f5034fbc6257fa5b1086689dc7d024df7226aa501fc28eba2d1f635840b96ad354a6989df5de8d0888414843736d0a4a6626a1e595e8785a70b10a38eb4632159aabf84959983e8852fd4d390eba6c423fac8ea117913cec46353bd90e5840d10d75956b86062d5b50fc729d422d4c31992de9cd2d9d3338c8a7a5ba708cd51526c0d284f067fd58f5ed1757d63044c1257a0e154189598379e58c00cd96088483010000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d818590273820183850158204d4114f03ab1bccd22182bb1106336fcab3b38f884306e1b6fda83df384a216184830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e4098848200193b1258403fb2637923c78dec4d5b932c09ac92ad445aa95da00a05edb447b40a07c59d5645187692f40e31114ad0f375532cf8e4f875740e2d7d0e343e0e14b533a31fec8108820282840058403fb2637923c78dec4d5b932c09ac92ad445aa95da00a05edb447b40a07c59d5645187692f40e31114ad0f375532cf8e4f875740e2d7d0e343e0e14b533a31fec58408ef320c2df6654a6188c45e9c639c0a686bf5a865295587d399dfeb05fe74ab67961a696b268c8bcec9372bc73aa9b1365ec007b3dfa0539eac00d154a31518c58409ef9f0e5ca23cd9365ec7a23f1b2d159da0d58e0242cb817c3bc946ba1c9e3629f1976f09a88370247bbc458c810d21a889e3ff6dd189ceea784bc9ab6dc9b0a5840932445abacd1e563a13a3342c3eef1a6b733cd77a5dcc156762946b7b3e4894d215d5770d9ced70341a1a5942699269043c50b3c8a0b9a26dc05a0fadf17ea078483010000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08204d81859027382018385015820018a398c415639148ecf39c3a5af68ef954e7fa5acc166253975019e9b022c8384830058200e5751c026e543b2e8ab2eb06099daa1d1e5df47778f7787faab45cdf12fe3a85820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b82035820d36a2619a672494604e11bb447cbcf5231e9f2ba25c2169177edc941bd50ad6c5820afc0da64183bf2664f3d4eec7238d524ba607faeeab24fc100eb861dba69971b58204e66280cd94d591072349bec0a3090a53aa945562efb6d08d56e53654b0e40988482001943835840505b237a1cb140020cc442f6e51c6a0f48ad3344427735a9ad5b755bece8a4ce5bed4f6bbbd00caffcdff6502359a16534ea5182badbcfbaf9b516edf305264a810982028284005840505b237a1cb140020cc442f6e51c6a0f48ad3344427735a9ad5b755bece8a4ce5bed4f6bbbd00caffcdff6502359a16534ea5182badbcfbaf9b516edf305264a58408b0960d234bda67d52432c5d1a26aca2bfb5b9a09f966d9592a7bf0c728a1ecd840eac5c3fe8a7edda024a7403b6d37705990828b3548332a3f850221c2098bf5840633fc347138ee155d038b9d1040ee1e45cea5b1e8627046c95f7fe4ba949b0569437962568eadef9d49e22becbf30192425c008d10e03004612633dbc307340b5840f714b4aa2b8e3d1972d826990e379a73c1bc67a6524a4e6bfb4ef025f9bc566a99f3d05fe5a6a6eec46520ecd24a146bf82ac7c49aa73007239daac11a750a088483010000826a63617264616e6f2d736c01a058204ba92aa320c60acc9ad7b9a64f2eda55c4d2ec28e604faf186708b4f0c4e8edf849fff8203d90102809fff82809fff81a08105"),
            {
                hasAgency: true,
                payloadLength: 7283,
                protocol: MiniProtocol.BlockFetch,
                transmissionTime: 0
            }
        );

        expect( msgs.length ).toEqual( 12 );
        expect( msgs[0] instanceof BlockFetchStartBatch ).toBe( true );
        expect( msgs.slice(1,11).every( msg => msg instanceof BlockFetchBlock ) ).toBe( true );
        expect( msgs[11] instanceof BlockFetchBatchDone ).toBe( true );
    });

})